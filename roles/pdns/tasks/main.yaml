- name: Create pdns group
  ansible.builtin.group:
    name: pdns
    system: true
  register: pdns_group
- name: Create pdns user
  ansible.builtin.user:
    name: pdns
    group: pdns
    home: '{{ pdns_config_dir }}'
    create_home: false
    shell: /usr/sbin/nologin
    system: true
  register: pdns_user

- name: Generate PowerDNS configuration directory
  ansible.builtin.file:
    path: '{{ pdns_config_dir }}'
    state: directory
    owner: pdns
    group: pdns
    mode: '0o755'
- name: Generate PowerDNS Recursor configuration directory
  ansible.builtin.file:
    path: '{{ pdns_config_dir }}/recursor.d'
    state: directory
    owner: pdns
    group: pdns
    mode: '0o755'

- name: Copy PowerDNS configuration
  ansible.builtin.template:
    src: templates/pdns.conf.j2
    dest: '{{ pdns_config_dir }}/pdns.conf'
    owner: pdns
    group: pdns
    mode: '0o600'
  register: pdns_server_config
- name: Copy PowerDNS Recursor configuration
  ansible.builtin.template:
    src: templates/recursor.yml.j2
    dest: '{{ pdns_config_dir }}/recursor.d/recursor.yml'
    owner: pdns
    group: pdns
    mode: '0o644'
  register: pdns_recursor_config

- name: Copy RPZ zone
  ansible.builtin.copy:
    src: '{{ pdns_recursor_rpz_zone }}'
    dest: '{{ pdns_config_dir }}/recursor.d/hosts.zone'
    owner: pdns
    group: pdns
    mode: '0o644'
  register: pdns_recursor_rpz_config

- name: Copy PowerDNS pod manifest
  ansible.builtin.template:
    src: templates/pdns-server-pod.yaml.j2
    dest: /etc/kubernetes/manifests/pdns-server.yaml
    owner: root
    group: root
    mode: '0o644'
- name: Copy PowerDNS Recursor pod manifest
  ansible.builtin.template:
    src: templates/pdns-recursor-pod.yaml.j2
    dest: /etc/kubernetes/manifests/pdns-recursor.yaml
    owner: root
    group: root
    mode: '0o644'
