apiVersion: v1
kind: Pod
metadata:
  name: etcd
  annotations:
    checksum/config: {{ etcd_config.checksum }}
spec:
  hostNetwork: true
  containers:
    - name: etcd
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: [ALL]
        readOnlyRootFilesystem: true
        runAsUser: {{ etcd_user.uid }}
        runAsGroup: {{ etcd_group.gid }}
        runAsNonRoot: true
      image: "{{ etcd_image }}:{{ etcd_version }}"
      command:
        - /usr/local/bin/etcd
        - --config-file=/etc/etcd/etcd.yaml
      ports:
        - name: client-grpc
          containerPort: 2379
        - name: peer
          containerPort: 2380
        - name: client-http
          containerPort: 2382
        - name: metrics
          containerPort: 8080
      livenessProbe:
        httpGet:
          port: metrics
          path: /livez
      readinessProbe:
        httpGet:
          port: metrics
          path: /readyz
      volumeMounts:
        - name: config
          mountPath: /etc/etcd
        - name: data
          mountPath: /var/lib/etcd
  volumes:
    - name: config
      hostPath:
        type: Directory
        path: {{ etcd_config_dir }}
    - name: data
      hostPath:
        type: Directory
        path: {{ etcd_data_dir }}
