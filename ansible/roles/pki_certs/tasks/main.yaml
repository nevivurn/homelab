- name: Generate cert base directory
  ansible.builtin.file:
    path: '{{ pki_certs_dir }}'
    state: directory
    owner: '{{ pki_certs_user }}'
    group: '{{ pki_certs_group }}'
    mode: '0o700'

- name: Install cryptography dependencies
  ansible.builtin.apt:
    name: python3-cryptography
    state: present

- name: Generate private key
  community.crypto.openssl_privatekey:
    path: '{{ pki_certs_dir }}/{{ pki_certs_id }}.key'
    type: '{{ pki_certs_algo | default("Ed25519") }}'
    owner: '{{ pki_certs_user }}'
    group: '{{ pki_certs_group }}'
- name: Generate CSR
  community.crypto.openssl_csr:
    path: '{{ pki_certs_dir }}/{{ pki_certs_id }}.csr'
    privatekey_path: '{{ pki_certs_dir }}/{{ pki_certs_id }}.key'
    subject_alt_name: '{{ ["DNS:" + inventory_hostname, "IP:" + ip, "IP:127.0.0.1"] + (pki_certs_extra_sans | default([])) }}'
    subject_alt_name_critical: true
    key_usage:
      - digitalSignature
      - keyEncipherment
    extended_key_usage: '{{ pki_certs_ekus }}'
    owner: '{{ pki_certs_user }}'
    group: '{{ pki_certs_group }}'
    return_content: true
  register: pki_certs_csr
- name: Sign CSR
  delegate_to: '{{ pki_certs_ca_host }}'
  community.crypto.x509_certificate:
    path: '{{ pki_certs_ca_basedir }}/certs/{{ inventory_hostname }}-{{ pki_certs_id }}.crt'
    csr_content: '{{ pki_certs_csr.csr }}'
    provider: ownca
    ownca_path: '{{ pki_certs_ca_basedir }}/ca.crt'
    ownca_privatekey_content: "{{ lookup('community.sops.sops', pki_certs_ca_basedir + '/ca.sops.key') }}"
    return_content: true
  register: pki_certs_crt

- name: Read CA certificate
  delegate_to: '{{ pki_certs_ca_host }}'
  ansible.builtin.slurp:
    src: '{{ pki_certs_ca_basedir }}/ca.crt'
  register: pki_certs_ca_crt
- name: Copy CA certificate
  ansible.builtin.copy:
    dest: '{{ pki_certs_dir }}/{{ pki_certs_ca_prefix | default("") }}ca.crt'
    content: '{{ pki_certs_ca_crt.content | b64decode }}'
    owner: '{{ pki_certs_user }}'
    group: '{{ pki_certs_group }}'
    mode: '0o644'

- name: Copy certificate
  ansible.builtin.copy:
    dest: '{{ pki_certs_dir }}/{{ pki_certs_id }}.crt'
    content: '{{ pki_certs_crt.certificate }}'
    owner: '{{ pki_certs_user }}'
    group: '{{ pki_certs_group }}'
    mode: '0o644'
