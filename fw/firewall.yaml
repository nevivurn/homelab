config:
  - global-options source-validation strict
  - global-options state-policy established action accept
  - global-options state-policy invalid action drop
  - global-options state-policy related action accept

  # define infra service addresses
  - group address-group INFRA-addr4 address 10.64.20.4-10.64.20.5
  - group ipv6-address-group INFRA-addr6 address fdbc:ba6a:38de:20::4-fdbc:ba6a:38de:20::5
  # define infra services, except DHCP
  - group port-group INFRA-port port 53
  - group port-group INFRA-port port 123
  # define DHCP relay addresses
  - group address-group DHCP4-RELAY address 10.64.10.4-10.64.10.5 # HOME
  - group address-group DHCP4-RELAY address 10.64.11.4-10.64.11.5 # GUEST
  #- group address-group DHCP4-RELAY address 10.64.30.4-10.64.30.5 # K8S
  - group ipv6-address-group DHCP6-RELAY address fdbc:ba6a:38de:10::4-fdbc:ba6a:38de:10::5 # HOME
  - group ipv6-address-group DHCP6-RELAY address fdbc:ba6a:38de:11::4-fdbc:ba6a:38de:11::5 # GUEST
  #- group address-group DHCP6-RELAY address fdbc:ba6a:38de:30::4-fdbc:ba6a:38de:30::5 # K8S

  - group address-group ROUTER-addr4 address 10.64.10.1-10.64.10.3 # HOME
  - group address-group ROUTER-addr4 address 10.64.11.1-10.64.11.3 # GUEST
  - group address-group ROUTER-addr4 address 10.64.20.1-10.64.20.3 # INFRA
  #- group address-group ROUTER-addr4 address 10.64.30.1-10.64.30.3 # K8S
  - group address-group ROUTER-addr4 address 10.64.200.1-10.64.200.2 # ROUTER
  - group address-group ROUTER-addr4 address 10.64.200.4 # ROUTER-VRRP

  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:10::1-fdbc:ba6a:38de:10::3 # HOME
  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:11::1-fdbc:ba6a:38de:11::3 # GUEST
  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:20::1-fdbc:ba6a:38de:20::3 # INFRA
  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:30::1-fdbc:ba6a:38de:30::3 # K8S
  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:200::1-fdbc:ba6a:38de:200::2 # ROUTER
  #- group ipv6-address-group ROUTER-addr6 address fdbc:ba6a:38de:200::4 # ROUTER-VRRP

zones:
  WAN:
    members: [eth0.99]
    config:
      - intra-zone-filtering action drop
    tables:
      EGRESS-WAN:
        zones:
          - HOME
          - GUEST
          - INFRA
          #- K8S
          - LOCAL
        config:
          - default-action accept
        rules:
          10: # MSS clamping
            - protocol tcp
            - tcp flags syn
            - set tcp-mss 1460
            - action continue

  LOCAL:
    config:
      - local-zone
      - default-log
    tables:
      INGRESS-LAN:
        zones:
          - HOME
          - INFRA
          #- K8S
          - ROUTER
        config:
          - default-log
        rules:
          10: &allow-icmp # allow necessary icmp
            - ipv4: icmp type-name echo-request
            - ipv6: protocol ipv6-icmp
            - action accept
          100: &allow-vrrp # allow vrrp
            - ipv4: source group address-group ROUTER-addr4
            - ipv4: protocol vrrp
            - ipv4: action accept
          101: # allow conntrack-sync
            - ipv4: source group address-group ROUTER-addr4
            - ipv4: protocol udp
            - ipv4: destination port 3780
            - ipv4: action accept
          110: # allow SSH
            - protocol tcp
            - destination port 22
            - action accept
      INGRESS-GUEST:
        zones:
          - GUEST
        config:
          - default-log
        rules:
          10: *allow-icmp
          100: *allow-vrrp

      INGRESS-WAN:
        zones:
          - WAN
        rules:
          10: *allow-icmp

  ROUTER:
    members: [eth0.200]
    config:
      - default-log
    tables:
      EGRESS-ROUTER: &egress
        zones: [LOCAL]
        config:
          - default-action accept
      LAN-ROUTER:
        <<: *egress
        zones:
          - HOME
          - INFRA
          #- K8S

  INFRA:
    members: [eth0.20]
    config:
      - default-log
    tables:
      EGRESS-INFRA: *egress
      GUEST-INFRA:
        zones:
          - GUEST
        config:
          - default-log
        rules: &infra-rules
          10: # allow ping
            - ipv4: icmp type-name echo-request
            - ipv4: destination group address-group INFRA-addr4
            - ipv6: icmpv6 type-name echo-request
            - ipv6: destination group address-group INFRA-addr6
            - action accept
          110: # allow DHCP relay traffic
            - protocol udp
            - ipv4: source group address-group DHCP4-RELAY
            - ipv4: destination group address-group INFRA-addr4
            - ipv4: destination port 67
            - ipv6: source group address-group DHCP6-RELAY
            - ipv6: destination group address-group INFRA-addr6
            - ipv6: destination port 547
            - action accept
          120: # allow other infra services
            - ipv4: destination group address-group INFRA-addr4
            - ipv6: destination group address-group INFRA-addr6
            - protocol tcp_udp
            - destination group port-group INFRA-port
            - action accept
      LAN-INFRA:
        zones:
          - HOME
          - ROUTER
          #- K8S
        config:
          - default-log
        rules:
          <<: *infra-rules
          10: &allow-ping # allow ping
            - ipv4: icmp type-name echo-request
            - ipv6: icmpv6 type-name echo-request
            - action accept
          200: # allow SSH
            - protocol tcp
            - destination port 22
            - action accept
          210: # allow proxmox
            - protocol tcp
            - destination port 8006
            - action accept

  HOME:
    members: [eth0.10]
    config:
      - default-log
    tables:
      EGRESS-HOME: *egress
      LAN-HOME:
        zones:
          - ROUTER
          - INFRA
          #- K8S
        config:
          - default-log
        rules:
          10: *allow-ping
          200: # allow SSH
            - protocol tcp
            - destination port 22
            - action accept

  GUEST:
    members: [eth0.11]
    config:
      - default-log
    tables:
      EGRESS-GUEST: *egress
      LAN-GUEST:
        zones:
          - ROUTER
          - INFRA
          - HOME
          #- K8S
        config:
          - default-log
        rules:
          10: *allow-ping
          200: # allow SSH
            - protocol tcp
            - destination port 22
            - action accept
